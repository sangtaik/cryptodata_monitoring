# CryptoData Monitoring (BTC/KRW 호가 데이터 모니터링 시스템)

## 소개 📖
CryptoData Monitoring 프로젝트는 **국내 주요 암호화폐 거래소들의 비트코인(BTC)/원화(KRW) 호가(Orderbook) 데이터를 실시간으로 수집**하고 저장하며, **수집된 데이터를 시각화하고 관리할 수 있는 웹 대시보드**를 제공하는 시스템입니다...

CryptoData Monitoring 프로젝트는 국내 주요 암호화폐 거래소들의 비트코인(BTC)/원화(KRW) 호가(Orderbook) 데이터를 실시간으로 수집하고 저장하며, 수집된 데이터를 시각화하고 관리할 수 있는 웹 대시보드를 제공하는 시스템입니다. 이 프로젝트를 통해 업비트(Upbit), 빗썸(Bithumb), 코빗(Korbit), 코인원(Coinone) 등 여러 거래소의 호가 현황을 한눈에 모니터링하고 비교할 수 있습니다.개발자는 본 리포지토리를 클론하여 Jupyter Notebook 상에서 곧바로 데이터를 수집하고, FastAPI 기반 웹 인터페이스를 띄워 실시간 데이터 모니터링 및 관리 페이지를 활용할 수 있습니다. 프로젝트 전반에 걸쳐 Python으로 구현되었으며, WebSocket (또는 REST) API를 활용한 데이터 수집, JSON 형식 데이터 저장, FastAPI와 Jinja2를 활용한 웹 서버 구성 등 데이터 엔지니어링 및 간단한 풀스택 개발 요소를 포함하고 있습니다.

## 주요 기능 ✨

다중 거래소 호가 데이터 수집 – 업비트, 빗썸, 코빗, 코인원의 BTC/KRW 호가 정보를 실시간 수집합니다 (WebSocket API 우선 사용, 불가능한 경우 REST API 활용). 각 거래소별 매수/매도 상위 10개 호가 가격과 수량을 지속적으로 가져옵니다.

JSON 형식 데이터 저장 – 수집된 호가 데이터를 JSON 파일로 저장합니다. 시간별(시간당)로 파일을 분할 저장하며, 파일명에 타임스탬프를 포함하여 데이터를 관리합니다. (예: upbit_orderbook_20250404_14.json 형태로 2025-04-04 14시 데이터 저장)

로그 기록 – 데이터 수집 시작/종료, 에러 발생 등 주요 이벤트를 로그 파일에 남깁니다. (예: collector.log에 각 수집 쓰레드의 이벤트 로그 기록)

Jupyter Notebook 기반 실행 – 데이터 수집 및 웹 서버 기능이 각각 Jupyter Notebook (sub1, sub2)으로 제공되어 단계별 실행과 출력 확인이 용이합니다. 필요한 패키지는 Notebook 내에서 설치하거나 사전 설치할 수 있습니다.

웹 대시보드 (FastAPI) – 수집된 데이터를 확인하고 관리할 수 있는 FastAPI 기반 웹 인터페이스를 제공합니다. HTML 템플릿 (index.html 사용)으로 구성된 대시보드에서 거래소별 지원 티커 목록을 보여주고, 특정 거래쌍의 호가 이력 데이터 조회 기능을 제공합니다.

티커 관리 기능 – 웹 인터페이스를 통해 새로운 거래쌍(Ticker)을 추가 또는 제거할 수 있습니다. 기본 제공되는 BTC/KRW 티커 외에 사용자가 ETH/KRW 등의 티커를 추가하면 목록에 반영되며, 필요 시 티커를 삭제하여 모니터링 범위를 조정할 수 있습니다. (기본 티커는 보호되어 삭제할 수 없도록 처리)

데이터 시각화 및 모니터링 – 선택된 거래소의 특정 코인 호가 데이터를 불러와 시계열 형태로 호가 변동 추이를 시각화합니다. (웹 페이지에서 JSON 데이터를 시간순으로 정렬하여 표시) 또한, 각 거래소 수집기의 **실행 상태(정상 작동 또는 오류)**를 모니터링하는 기능이 포함되어 있습니다.

서비스 로그 검색 기능 – Web Server에 해당 조건에 맞는 서버 로그(server.log) 내 기록을 필터링하여 보여줘, Web Server의 동작을 추적하거나 에러 발생을 확인할 수 있습니다.

## 설치 및 실행 방법 🚀
*****
이 프로젝트는 Python 3 환경에서 Jupyter Notebook으로 구동됩니다. 아래 절차에 따라 설치 및 실행하세요:

리포지토리 클론:터미널에서 다음 명령으로 리포지토리를 클론합니다:

git clone https://github.com/sangtaik/cryptodata_monitoring.git
cd cryptodata_monitoring

의존성 설치:프로젝트에 필요한 패키지를 설치합니다 (이미 설치되어 있다면 생략 가능). 필요한 주요 패키지로는 websocket-client (실시간 데이터 수집), requests (REST API 호출), fastapi 및 uvicorn (웹 서버), python-multipart (폼 데이터 처리), Jinja2 (템플릿), nest_asyncio (노트북 내 비동기 지원) 등이 있습니다.
```
pip install websocket-client requests fastapi uvicorn python-multipart nest_asyncio
```
또는 requirements.txt 파일이 제공되는 경우 다음과 같이 일괄 설치할 수도 있습니다:
```
pip install -r requirements.txt
```
Jupyter Notebook이 설치되어 있지 않다면 pip install notebook 명령으로 설치해주세요.

데이터 수집 노트북 실행:Jupyter Notebook을 열고 sub1_jupyter_version_loop_all_exchange_orderbook_history_btc_krw.ipynb 파일을 실행합니다. 해당 노트북을 처음부터 끝까지 순차적으로 실행하면, 각 거래소별 수집 스레드가 시작되어 약 10분간 BTC/KRW 호가 데이터를 수집합니다.실행 중에는 콘솔 로그를 통해 각 거래소의 WebSocket 구독 성공, 데이터 수신, 오류 재시도 등의 로그를 확인할 수 있습니다. 수집된 데이터는 JSON 파일 형태로 현재 디렉토리에 저장되며, 기본 설정으로 10분 후 자동으로 종료됩니다. (if __name__ == "__main__": 블록에서 time.sleep(600)으로 수집 시간 지정)

Note: 기본으로 10분 수집 후 종료하도록 설정되어 있으나, 필요시 해당 시간(600초)을 조정하거나, 수집 스레드를 지속 실행하도록 변경할 수 있습니다. 수집이 완료되면 collector.log 파일에 종료 로그가 기록되고, 열린 JSON 파일들도 자동으로 닫혀 저장됩니다.

웹 대시보드 노트북 실행:데이터를 성공적으로 수집했다면, 이제 sub2_webserver.ipynb 노트북을 실행하여 웹 서버를 구동합니다. 이 노트북을 순차 실행하면 FastAPI 앱이 실행되며, 마지막 셀에서 Uvicorn 서버가 127.0.0.1:8000 주소로 시작됩니다. (nest_asyncio를 통해 노트북 내에서 비동기 서버 실행)서버가 구동되면 브라우저를 열고 http://127.0.0.1:8000 (또는 http://localhost:8000)에 접속합니다. 접속 시 templates/index.html에 정의된 웹 대시보드 화면을 볼 수 있습니다. 이 상태에서 노트북은 서버를 계속 실행 중이어야 하므로, 웹 인터페이스를 사용하는 동안 해당 Jupyter 셀을 중지하지 말고 두십시오.

Tip: FastAPI 서버를 별도 프로세스로 실행하고 싶다면, sub2_webserver.ipynb 내용을 .py 파일로 저장한 뒤 uvicorn 파일명:app --reload 등의 명령으로도 실행이 가능합니다. 단, 이 경우 현재 디렉토리를 프로젝트 루트로 두고 실행하여야 템플릿과 JSON 파일을 정상적으로 불러옵니다.

## 주요 노트북 및 구성 🔍
*****
프로젝트는 두 개의 주요 Jupyter Notebook으로 구성되어 있으며, 각각 다음 역할을 수행합니다:

sub1_jupyter_version_loop_all_exchange_orderbook_history_btc_krw.ipynb – 데이터 수집 노트북으로, 여러 거래소의 BTC/KRW 호가 데이터를 동시에 수집합니다. 각 거래소마다 별도의 쓰레드(threading.Thread)로 Collector 인스턴스를 실행하며, WebSocket을 지원하는 거래소(업비트, 코빗, 코인원)는 실시간 스트림 수집을, 빗썸은 REST API로 주기적 수집을 수행합니다. 수집된 주문상세는 BaseCollector 기반 클래스로 처리되어 JSON 배열로 파일에 기록되고, 매 시각 정각에 자동으로 새로운 파일로 롤오버(분할)됩니다. 약 0.5초 간격으로 각 거래소의 상위 10개 호가를 기록하며, 10분간 수집 후 자동 종료되도록 구현되어 있습니다. 수집 과정의 모든 이벤트 (연결 성공, 데이터 수신, 오류 발생 및 재시도 등)는 collector.log에 남겨지므로, 실행 후 해당 로그를 통해 각 거래소 수집기의 동작을 확인할 수 있습니다.

sub2_webserver.ipynb – 웹 대시보드 노트북으로, FastAPI를 사용한 간단한 웹 서버입니다. 이 서버는 Jinja2 템플릿( templates/index.html )을 통해 HTML 페이지를 렌더링하며, 다음과 같은 엔드포인트를 제공합니다:

GET / – 메인 대시보드 페이지를 제공하며, 내부적으로 tickers.json 파일을 로드하여 거래소별 모든 티커 목록을 표시합니다. 기본 상태에서는 어떤 티커도 선택되지 않은 채로 로드되며, 직전 날짜(전일)의 데이터 조회를 준비합니다.

POST /select – 사용자가 대시보드에서 하나 이상의 티커를 선택하고 "조회" 버튼을 눌렀을 때 호출됩니다. 선택된 티커 목록을 받아들여 해당 티커들의 전일 호가 이력 데이터를 JSON 파일들에서 불러옵니다. 불러온 데이터는 시간순으로 정렬되어 템플릿에 전달되며, 페이지에 호가 스냅샷 리스트로 표시됩니다. (예: 시간별로 상위 10개 호가 가격/수량 목록) 만약 티커를 선택하지 않고 조회하면 오류 메시지를 보여줍니다.

POST /add_ticker – 대시보드의 "티커 추가" 폼을 통해 새 티커(symbol)를 추가할 때 호출됩니다. 선택한 거래소와 입력한 티커를 tickers.json에 저장하고, 페이지를 리다이렉트하여 업데이트된 티커 목록을 반영합니다. 이때 이미 존재하는 티커는 중복으로 추가되지 않으며, 새로 추가된 티커는 이후 세션부터 선택 가능해집니다. (참고: 추가된 티커에 대한 실시간 수집은 즉시 시작되지 않으며, 데이터 수집을 위해서는 해당 티커에 대한 Collector 확장이 필요합니다. 현재는 관리 기능 상 추가만 지원합니다.)

POST /delete_ticker – 티커 목록 옆의 "삭제" 버튼을 누르면 호출되어, tickers.json에서 해당 티커를 제거합니다. 기본으로 정의된 티커(예: BTC/KRW)는 제거하지 못하도록 서버에서 보호하며, 그 외 사용자가 추가한 티커는 삭제 가능합니다. 삭제 후에도 페이지를 리다이렉트하여 최신 티커 목록을 보여줍니다.

POST /search_log – 화면 상단의 로그 검색 폼에서 날짜와 거래소를 입력하고 "검색" 버튼을 누르면 호출됩니다. 서버 실행 로그 파일인 server.log를 열어 입력된 날짜 문자열을 포함하는 로그 행을 모두 수집하고, 선택적으로 거래소 이름으로 필터링합니다. 검색 결과 로그 라인들을 화면 하단에 표시하여, 특정 일자/거래소의 동작 기록을 확인할 수 있게 합니다. 로그 파일이 없거나 비어있는 경우 안내 메시지를 출력합니다.

(추가) 데이터 수집기 상태 모니터링 – 서버 기동 시 백그라운드 스레드(status_updater)가 실행되어, 내부적으로 각 거래소 수집 상태를 관리하는 status_info 딕셔너리를 주기적으로 업데이트합니다. 현재 프로토타입에서는 임의로 “Running” ↔ “Error” 상태를 토글하며 동작을 시뮬레이션하지만, 실제 환경에서는 수집 쓰레드와 연계하여 실시간 수집 상태를 UI에 표시할 수 있습니다. (예: 거래소별 수집 진행 상태 표시) 이 정보는 템플릿에 전달되어 UI에서 시각적으로 표시되도록 구현 가능합니다.

## 웹 서버 대시보드 사용 방법 🌐
*****
위의 sub2 웹 대시보드 노트북을 실행한 후 브라우저에서 열리는 대시보드 페이지를 통해 다음과 같은 작업을 할 수 있습니다:

웹 대시보드 메인 화면 예시입니다. 상단에는 로그 검색을 위한 입력란(날짜 및 거래소)이 있고, 우측에 검색 버튼이 배치되어 있습니다. 좌측 섹션에는 거래소별 티커 목록이 그룹으로 표시되며 (예: Upbit 아래 BTC/KRW, ETH/KRW 등이 나열), 각 티커 옆에는 선택 체크박스가 있습니다. 중간의 "조회" 버튼을 통해 선택한 티커들의 데이터를 불러올 수 있으며, 하단에는 선택된 티커들의 호가 변동 내역이 시간순으로 테이블 형식으로 나타납니다. 화면 오른쪽 하단에는 티커 추가/삭제를 위한 폼이 있어, 새로운 티커를 목록에 추가하거나 기존 티커를 삭제할 수 있습니다. 기본 BTC/KRW 티커들은 삭제가 불가능하도록 비활성화되어 있으며, 이를 통해 핵심 모니터링 대상은 항상 유지됩니다. (만약 수집기 상태 모니터링이 활성화된 경우, 각 거래소 섹션 옆에 🟢/🔴 아이콘 등으로 Collector 상태를 표시할 수도 있습니다.)

## 프로젝트 구조 📂
*****
프로젝트의 주요 파일 및 폴더 구조는 아래와 같습니다. (orderbook_data 폴더 및 JSON 파일은 데이터 수집 노트북 실행 후 생성됩니다.)
```
cryptodata_monitoring/
├── sub1_jupyter_version_loop_all_exchange_orderbook_history_btc_krw.ipynb  # 데이터 수집 노트북
├── sub2_webserver.ipynb                               # 웹 대시보드 노트북
├── tickers.json                                       # 거래소별 티커 목록 (초기 BTC/KRW 포함)
├── templates/                                         # FastAPI 템플릿 폴더
│   └── index.html                                     # 대시보드 HTML 페이지 템플릿
├── orderbook_data/                                    # (생성되는 데이터 저장 폴더)
│   └── 20250404/                                      # 예시: 2025-04-04 수집 데이터 폴더 (전일자 기준)
│       ├── upbit_orderbook_20250404_12.json           # 업비트 2025-04-04 12시 데이터
│       ├── upbit_orderbook_20250404_13.json           # 업비트 2025-04-04 13시 데이터
│       ├── korbit_orderbook_20250404_12.json          # 코빗 2025-04-04 12시 데이터 
│       ├── ... (생략) ...
│       ├── coinone_orderbook_20250404_13.json         # 코인원 2025-04-04 13시 데이터
│       └── bithumb_orderbook_20250404_13.json         # 빗썸 2025-04-04 13시 데이터
├── collector.log                                      # 수집기 로그 파일 (sub1 실행 시 생성)
└── server.log                                         # 서버 로그 파일 (sub2 실행 시 생성)
```

## 사용 예시 💡
*****
아래는 이 프로젝트를 활용하여 BTC/KRW 호가 데이터를 수집하고 웹 대시보드에서 확인하는 전체 예시 시나리오입니다:

데이터 수집 시작: 터미널 또는 Jupyter 환경에서 sub1_jupyter_version_loop_all_exchange_orderbook_history_btc_krw.ipynb를 실행합니다. 네 개의 수집기가 병렬로 구동되어 업비트, 빗썸, 코빗, 코인원의 BTC/KRW 호가 데이터를 약 10분 동안 수집합니다. 실행 즉시 collector.log에 각 거래소 수집 시작 로그가 기록되고, 실시간으로 JSON 파일들이 생성되어 갱신됩니다.

수집 완료 및 데이터 확인: 10분 후 수집이 완료되면, 노트북 셀이 종료되고 collector.log에 "Main: 10 minutes elapsed, stopping collectors." 등의 로그가 추가됩니다. cryptodata_monitoring/orderbook_data/YYYYMMDD/ 경로에 거래소별로 시간대가 분할된 JSON 파일들이 생성되어 있는 것을 확인합니다. (예: orderbook_data/20250404/upbit_orderbook_20250404_12.json, ..._13.json 등)

웹 대시보드 실행: 이제 sub2_webserver.ipynb를 실행하여 FastAPI 서버를 기동합니다. 마지막 셀 실행 후 터미널 출력이나 Jupyter 로그에 "Uvicorn running on http://127.0.0.1:8000" 메시지가 보이면, 웹 서버가 정상적으로 시작된 것입니다. 브라우저에서 http://127.0.0.1:8000로 접속해 대시보드 페이지를 엽니다.

호가 데이터 조회: 대시보드 좌측에서 원하는 거래소의 BTC/KRW 티커를 선택합니다 (여러 개 선택 가능). 그리고 "조회" 버튼을 누르면 선택된 모든 티커에 대한 전일(예: 2025-04-04)의 호가 이력을 불러와 화면 하단에 표 형태로 표시합니다. 각 티커마다 시간순으로 정렬된 호가 스냅샷이 출력되어, 10분간 축적된 주문 현황의 변화를 확인할 수 있습니다. 예를 들어 업비트와 빗썸을 선택했다면, 두 거래소 각각의 상위 10호가 변동 내역이 별도의 표로 나타납니다.

로그 검색 활용: 문제가 발생했거나 수집 상황을 더 자세히 보고 싶다면, 상단의 로그 검색 섹션을 이용합니다. 날짜 입력란에 20250404를, 거래소에 Upbit을 입력한 뒤 검색하면, server.log에서 2025-04-04에 발생한 Upbit 관련 로그 (예: "Upbit: WebSocket connection opened", "Upbit: Subscribed to Upbit KRW-BTC orderbook", "Upbit: WebSocket closed ... Reconnecting..." 등)가 필터링되어 화면 중간에 표시됩니다. 이를 통해 각 거래소 수집기의 동작 이력을 웹에서 바로 확인할 수 있습니다.

티커 추가/삭제: 새로운 자산의 호가도 추적해보고 싶다면, 화면 오른쪽 하단의 티커 추가 폼을 사용합니다. 예를 들어 업비트 거래소에 이더리움(ETH/KRW)을 추가하려면, 거래소 드롭다운에서 "Upbit"을 선택하고 티커 입력란에 ETH/KRW라고 입력한 뒤 "추가" 버튼을 클릭합니다. 페이지가 리프레시되면서 Upbit 섹션에 ETH/KRW 티커가 목록에 추가된 것을 확인할 수 있습니다. (이때 ETH/KRW에 대한 과거 데이터는 수집된 바 없으므로 조회 결과가 없을 수 있습니다.) 필요 없어진 티커는 목록 옆의 삭제 버튼을 눌러 제거할 수 있습니다. 기본 BTC/KRW 티커들은 삭제 버튼이 비활성화되어 있습니다.

실시간 상태 모니터링: 대시보드에서 옆을 보면 수집기 상태 표시 아이콘/텍스트가 있습니다. 수집기가 정상 동작 중이면 "🟢 Running", 에러 상태이면 "🔴 Error" 등의 표시가 나타납니다. 수집 중에는 기본적으로 Running 상태로 유지되다가, 본 예시 구현에서는 내부적으로 10% 확률로 에러 상태를 임의 생성하도록 했습니다. 만약 에러로 표시된다면 수집기 로그를 확인하여 재시도 로직이 동작했는지 검토할 수 있습니다. 이러한 상태 모니터링을 통해 Web Service가 원활한지 한눈에 파악할 수 있습니다.

이상으로 프로젝트의 주요 사용 흐름이 완료되었습니다. 수집한 데이터는 JSON 파일로 계속 남아 있어 추후 오프라인 분석이나 추가 시각화에 활용할 수 있습니다. 웹 대시보드를 종료하려면 Jupyter에서 실행 중인 uvicorn 셀을 중지하거나 노트북 커널을 종료하면 됩니다.

## 라이선스 📝

이 프로젝트는 MIT 라이선스로 배포됩니다. 자유롭게 소프트웨어를 사용하고 수정할 수 있으며, 자세한 내용은 동봉된 LICENSE 파일을 참고하시기 바랍니다.