<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orderbook Data Management</title>
  <style>
    /* Basic styling for clarity and clean formatting */
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 1.5em; }
    h2 { margin-top: 1.5em; font-size: 1.2em; }
    ul { list-style: none; padding-left: 0; }
    li { margin: 4px 0; }
    table { border-collapse: collapse; margin: 0.5em 0; width: auto; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: right; }
    th { background: #f9f9f9; }
    label { margin-right: 8px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Crypto Orderbook Collector ‚Äì Management Page</h1>
  
  <!-- Ticker selection and list -->
  <h2>Tracked Tickers</h2>
  <p>Select up to 5 tickers to view orderbook data from the previous day ({{ date_str }}):</p>
  {% if error_msg %}
    <p class="error">{{ error_msg }}</p>
  {% endif %}
  
  <!-- Selection form (submit to /select). Uses form attribute to associate checkboxes. -->
  <form id="selectForm" method="post" action="/select">
    <button type="submit">View Selected Data</button>
  </form>
  
  <!-- List all tickers with checkboxes, grouped by exchange -->
  {% for exchange, tickers in tickers_data.items() %}
    <h3>{{ exchange }}</h3>
    <ul>
      {% for ticker in tickers %}
        <li>
          <input type="checkbox" 
                 name="tickers" 
                 value="{{ exchange }}:{{ ticker }}" 
                 id="{{ exchange }}-{{ ticker|replace('/', '_') }}" 
                 form="selectForm"
                 {% if selected_tickers and (exchange ~ ':' ~ ticker) in selected_tickers %}checked{% endif %}>
          <label for="{{ exchange }}-{{ ticker|replace('/', '_') }}">{{ ticker }}</label>
          <!-- Delete button for this ticker -->
		{% set is_default = default_tickers.get(exchange) and ticker in default_tickers[exchange] %}
		{% if not is_default %}
		  <form method="post" action="/delete_ticker" style="display:inline;">
			<input type="hidden" name="exchange" value="{{ exchange }}">
			<input type="hidden" name="ticker" value="{{ ticker }}">
			<button type="submit">Delete</button>
		  </form>
		{% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endfor %}
  
  <!-- Add new ticker form -->
  <h2>Add New Ticker</h2>
  <form method="post" action="/add_ticker">
    <label for="exchange">Exchange:</label>
    <select name="exchange" id="exchange">
      <option value="Upbit">Upbit</option>
      <option value="Bithumb">Bithumb</option>
      <option value="Korbit">Korbit</option>
      <option value="Coinone">Coinone</option>
    </select>
    <label for="ticker">Ticker Pair:</label>
    <input type="text" name="ticker" id="ticker" placeholder="e.g. ETH/KRW" required />
    <button type="submit">Add</button>
  </form>
  
  <!-- Display results if any tickers were selected -->
  {% if result_data %}
    <h2>Orderbook Data Results ({{ date_str }} KST)</h2>
    {% for ticker, snapshots in result_data.items() %}
      <h3>{{ ticker }}</h3>
      {% if snapshots and snapshots|length > 0 %}
        <!-- Loop through each snapshot entry for this ticker -->
        {% for snapshot in snapshots %}
          <p><strong>Timestamp:</strong> {{ snapshot.time }}</p>
          <table>
            <thead>
              <tr>
                <th>Bid Price</th><th>Bid Volume</th><th>Ask Price</th><th>Ask Volume</th>
              </tr>
            </thead>
            <tbody>
              {% for bid in snapshot.bids %}
                {% set i = loop.index0 %}
                {% set ask = snapshot.asks[i] %}
                <tr>
                  <td>{{ bid[0] }}</td>
                  <td>{{ bid[1] }}</td>
                  <td>{{ ask[0] }}</td>
                  <td>{{ ask[1] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      {% else %}
        <p><em>No data available for this ticker on {{ date_str }}.</em></p>
      {% endif %}
      <hr />
    {% endfor %}
  {% endif %}
  
  <!-- JavaScript to enforce max 5 checkbox selections -->
  <script>
    const maxSelections = 5;
    const checkboxList = document.querySelectorAll('input[name="tickers"]');
    checkboxList.forEach(cb => {
      cb.addEventListener('change', () => {
        const checkedCount = document.querySelectorAll('input[name="tickers"]:checked').length;
        if (checkedCount > maxSelections) {
          alert("You can select up to 5 tickers at a time.");
          cb.checked = false;
        }
      });
    });
  </script>
  
  <h2>üîçService Î°úÍ∑∏ Í≤ÄÏÉâ</h2>
  <form method="post" action="/search_log">
    <label for="log_date">ÎÇ†Ïßú (YYYY-MM-DD):</label>
    <input type="date" id="log_date" name="log_date" value="{{ log_date or '' }}" required>
    <!-- <input type="text" id="log_date" name="log_date" placeholder="2025-04-04" required> -->

    <label for="log_level">Log Level:</label>
    <select name="log_exchange" id="log_level">
      <option value="">Ï†ÑÏ≤¥</option>
      <option value="INFO">INFO</option>
      <option value="WARNING">WARNING</option>
      <option value="ERROR">ERROR</option>
      <option value="DEBUG">DEBUG</option>
      <option value="CRITICAL">CRITICAL</option>
    </select>

    <button type="submit">Í≤ÄÏÉâ</button>
  </form>
  
  
  {% if log_results %}
    <h3>üìÑ Î°úÍ∑∏ Í≤∞Í≥º ({{ log_date }}{% if log_exchange %} / {{ log_exchange }}{% endif %})</h3>
    <pre style="background:#f9f9f9; padding:10px; border:1px solid #ccc; max-height:300px; overflow-y:auto;">
  {% for line in log_results %}
  {{ line }}
  {% endfor %}
    </pre>
  {% endif %}
  
</body>
</html>
