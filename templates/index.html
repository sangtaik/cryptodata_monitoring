<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Orderbook Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .main-container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      align-items: flex-start;
    }
    .sidebar, .orderbook, .order-form, .info-panel {
      padding: 10px;
      border: 1px solid #ccc;
      background: #fff;
    }
    .sidebar { width: 200px; background: #f4f4f4; }
    .orderbook { width: 300px; background: #f7f9fc; }
    .order-form { width: 300px; background: #fff; }
    .info-panel { flex: 1; background: #fafafa; max-width: 500px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: right; }
    th { background: #eee; }
    form { margin-bottom: 1em; }
  </style>
</head>
<body>
  <h1>📊 Orderbook 관리 대시보드</h1>

  <div class="main-container">
    <!-- Sidebar: Ticker 목록 -->
    <div class="sidebar">
      <h2>🎯 Tracked Tickers</h2>
      {% for exchange, tickers in tickers_data.items() %}
        <h3>{{ exchange }}</h3>
        <ul>
          {% for ticker in tickers %}
            <li>
              {{ ticker }}
              {% set is_default = default_tickers.get(exchange) and ticker in default_tickers[exchange] %}
              {% if not is_default %}
              <form method="post" action="/delete_ticker" style="display:inline;">
                <input type="hidden" name="exchange" value="{{ exchange }}">
                <input type="hidden" name="ticker" value="{{ ticker }}">
                <button type="submit">삭제</button>
              </form>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endfor %}

      <h3>➕ Add New Ticker</h3>
      <form method="post" action="/add_ticker">
        <label for="exchange">Exchange:</label>
        <select name="exchange" id="exchange">
          <option value="Upbit">Upbit</option>
          <option value="Bithumb">Bithumb</option>
          <option value="Korbit">Korbit</option>
          <option value="Coinone">Coinone</option>
        </select><br>
        <input type="text" name="ticker" placeholder="e.g. ETH/KRW" required>
        <button type="submit">추가</button>
      </form>
    </div>

    <!-- Orderbook -->
    <div class="orderbook">
      <h2>📈 Orderbook 보기</h2>
      <form id="selectForm" method="post" action="/select">
        {% for exchange, tickers in tickers_data.items() %}
          <h3>{{ exchange }}</h3>
          {% for ticker in tickers %}
            <input type="checkbox" name="tickers" value="{{ exchange }}:{{ ticker }}" 
              {% if selected_tickers and (exchange ~ ':' ~ ticker) in selected_tickers %}checked{% endif %}> {{ ticker }}<br>
          {% endfor %}
        {% endfor %}
        <button type="submit">View Selected</button>
      </form>

      {% if result_data %}
        {% for ticker, snapshots in result_data.items() %}
          <h4>{{ ticker }}</h4>
          {% for snap in snapshots %}
            <p><strong>{{ snap.time }}</strong></p>
            <table>
              <thead><tr><th>Bid Price</th><th>Bid Qty</th><th>Ask Price</th><th>Ask Qty</th></tr></thead>
              <tbody>
                {% for i in range(snap.bids|length) %}
                  <tr>
                    <td>{{ snap.bids[i][0] }}</td>
                    <td>{{ snap.bids[i][1] }}</td>
                    <td>{{ snap.asks[i][0] }}</td>
                    <td>{{ snap.asks[i][1] }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endfor %}
        {% endfor %}
      {% endif %}
    </div>

    <!-- Info Panel: 로그 검색 -->
    <div class="info-panel">
      <h2>🔍 Service 로그 검색</h2>
      <form method="post" action="/search_log">
        <label for="log_date">날짜:</label>
        <input type="date" id="log_date" name="log_date" value="{{ log_date or '' }}" required>

        <label for="log_level">Log Level:</label>
        <select name="log_exchange" id="log_level">
          <option value="">전체</option>
          <option value="INFO" {% if log_exchange == "INFO" %}selected{% endif %}>INFO</option>
          <option value="WARNING" {% if log_exchange == "WARNING" %}selected{% endif %}>WARNING</option>
          <option value="ERROR" {% if log_exchange == "ERROR" %}selected{% endif %}>ERROR</option>
          <option value="DEBUG" {% if log_exchange == "DEBUG" %}selected{% endif %}>DEBUG</option>
          <option value="CRITICAL" {% if log_exchange == "CRITICAL" %}selected{% endif %}>CRITICAL</option>
        </select>

        <button type="submit">검색</button>
      </form>

      {% if log_results %}
        <h3>📄 로그 결과</h3>
        <pre style="background:#f9f9f9; padding:10px; border:1px solid #ccc; max-height:300px; overflow-y:auto;">
{% for line in log_results %}{{ line }}
{% endfor %}
        </pre>
      {% endif %}
    </div>
  </div>
</body>
</html>
